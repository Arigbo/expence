<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard</title>
    <link rel="stylesheet" href="/style/custom.css" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />
    <link rel="shortcut icon" href="/Logomark.png" type="image/x-icon">
  </head>
  <body>
    <div class="dashboard">
      <nav class="navbar">
        <div class="navbar_inner">
          <div class="top">
            <div><img src="/Logomark.png" alt="" /></div>
            <h1 class="">Spen<span>track</span></h1>
          </div>
          <a href="./index.html" class="dash"
            ><i class="fas fa-cube"></i> Dashboard</a
          ><a href="/pages/transaction.html" class="transaction"
            ><i class="fas fa-exchange-alt"></i> Transactions</a
          >
          <a href="./budget.html" class="budget"><i class="fas fa-rocket"></i> Budgets</a>
          <a href="/" class="report"
            ><i class="fas fa-chart-line"></i> Reports</a
          >
          <a href="/" class="setting"><i class="fas fa-gear"></i> Setting</a>
        </div>
      </nav>
      <div class="dashboard_header">
        <div class="left">
          <div class="left_left">
            <i class="far fa-user"></i>
          </div>
          <div class="left_right">
            <h1>Hello</h1>
            <h4>Chally Pepper</h4>
          </div>
        </div>
        <div class="right">
          <i class="far fa-bell"></i>
        </div>
      </div>
      <div class="dashboard_header desktop">
        <div class="left">
          <i class="fas fa-bars bar"></i>
        </div>
        <div class="middle">
          <div class="middle_left">
            <p>Hello Colins, good morning!</p>
          </div>
          <div class="middle_right">
            <i class="fas fa-search"></i>
            <input type="search" placeholder="Search here...." />
          </div>
        </div>
        <div class="right">
          <div class="right_left">
            <h1><i class="far fa-bell"></i></h1>
          </div>
          <div class="right_right">
            <i class="fas fa-user"></i>
          </div>
        </div>
      </div>
      <div class="dashboard_inner">
        <div class="dashboard_inner_left">
            <section class="first">
              <div class="first_top">
                <h5>Total Balance:</h5>
                <a href="">View all</a>
              </div>
              <div class="first_bottom"><h1 id="displayTotalBalance">$0</h1></div>
            </section>

            <script>
            fetch('/db.json')
              .then(response => response.json())
              .then(data => {
              const transactions = data.transactions;

              // Calculate totals
              const totals = transactions.reduce(
                (acc, transact) => {
                acc[transact.type] += transact.amount;
                return acc;
                },
                { income: 0, expense: 0 }
              );
              const balance = totals.income - totals.expense;

              // Update total balance in the DOM
              document.getElementById('displayTotalBalance').textContent = `$${balance.toLocaleString()}`;
              })
              .catch(error => console.error('Error fetching transactions:', error));
            </script>
          <section class="second">
            <div class="second_header">
              <h1>Transaction Overview</h1>
              <p>An overview of all your transactions</p>
            </div>
            <div class="second_inner">
              <div class="card">
                <div class="card_inner">
                <div class="left income">
                <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                >
                <path
                d="M3 17L9 11L13 15L21 7"
                stroke="green"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                />
                <path
                d="M21 7L17 7M21 7L21 11"
                stroke="green"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                />
                </svg>
                </div>
                <div class="right">
                <h4 class="income">Income</h4>
                <h1 id="totalIncome">$0</h1>
                </div>
                </div>
                </div>
                <div class="card">
                <div class="card_inner">
                <div class="left expense">
                <svg
                xmlns="http://www.w3.org/2000/svg"
                viewBox="0 0 24 24"
                fill="none"
                >
                <path
                d="M3 7L9 13L13 9L21 17"
                stroke="red"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                />
                <path
                d="M21 17L17 17M21 17L21 13"
                stroke="red"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
                />
                </svg>
                </div>
                <div class="right">
                <h4 class="expense">Expense</h4>
                <h1 id="totalExpense">$0</h1>
                </div>
                </div>
                </div>
                <div class="card">
                <div class="card_inner">
                <div class="left saving">
                <i class="fas fa-wallet"></i>
                </div>
                <div class="right">
                <h4 class="saving">Savings</h4>
                <h1 id="totalSavings">$0</h1>
                </div>
                </div>
                </div>
                <div class="card">
                <div class="card_inner">
                <div class="left balance" style="background-color: rgba(255, 165, 0, 0.2); border-radius: 100%;">
                <i class="fas fa-coins" style="color: orange;"></i>
                </div>
                <div class="right">
                <h4 class="balance" style="color: orange;">Balance</h4>
                <h1 id="totalBalance">$0</h1>
                </div>
                </div>
                </div>
              <script>
              fetch('/db.json')
              .then(response => response.json())
              .then(data => {
              const transactions = data.transactions;

              // Calculate totals
              const totals = transactions.reduce(
              (acc, transact) => {
                acc[transact.type] += transact.amount;
                return acc;
              },
              { income: 0, expense: 0 }
              );
              const savings = totals.income - totals.expense;
              const balance = savings; // Assuming balance is equivalent to savings

              // Update totals in the DOM
              document.getElementById('totalIncome').textContent = `$${totals.income.toLocaleString()}`;
              document.getElementById('totalExpense').textContent = `$${totals.expense.toLocaleString()}`;
              document.getElementById('totalSavings').textContent = `$${savings.toLocaleString()}`;
              document.getElementById('totalBalance').textContent = `$${balance.toLocaleString()}`;
              })
              .catch(error => console.error('Error fetching transactions:', error));
              </script>
            </div>
          </section>
          <section class="third">
            <header>
              <h1>Expence, Savings & Income Chart</h1>
            </header>
            <div class="third_inner">
              <div class="btns">
                <select name="Select" id="btns_inner" onchange="updateChart(this.value)">
                  <option value="Select" disabled>Select</option>
                  <option value="daily" id="daily-btn">Daily</option>
                  <option value="weekly" id="weekly-btn">Weekly</option>
                  <option value="monthly" id="monthly-btn">Monthly</option>
                  <option value="yearly" id="yearly-btn">Yearly</option>
                </select>
              </div>
              <canvas id="expenseChart"> </canvas>
            </div>
          </section>
          <section class="fourth">
            <header>
              <h1>Recent Transactions</h1>
              <a href="./transaction.html">View all</a>
            </header>
            <div class="fourth_inner">
              <div class="fourth_inner_top">
                <h1>Date</h1>
                <h1>Description</h1>
                <h1>Category</h1>
                <h1>Amount</h1>
              </div>
              <div class="transacts">
                <div class="transacts_inner"></div>
              </div>
            </div>
          </section>
        </div>
        <div class="dashboard_inner_right">
          <section class="blog">
            <div class="blog_header">Daily tips</div>
            <div class="blog_inner">
              <div class="box"></div>
            </div>
          </section>
        </div>
      </div>
    </div>
  </body>
  <script>
    fetch('/db.json')
      .then(response => response.json())
      .then(data => {
        const transactions = data.transactions;

        // Populate transaction table
        transactions.forEach(transact => {
          document.querySelector(".transacts_inner").insertAdjacentHTML(
            "beforeend",
            `
            <div class="transact">
              <div class="firstCl">
                <p>${transact.date}</p>
              </div>
              <div class="secondCl">
                <p>${transact.description}</p>
              </div>
              <div class="thirdCl">
                <h5 class=${transact.type === "income" ? "green" : "red"}>
                  ${transact.type}
                </h5>
              </div>
              <div class="fourthCl">
                <h4 class=${transact.type === "expense" ? "red" : "green"}>
                  ${transact.type === "expense" ? "-" : "+"}${transact.amount}
                </h4>
              </div>
            </div>
            `
          );
        });

        // Group transactions by period
        const groupByPeriod = (transactions, period) => {
          return transactions.reduce((acc, transact) => {
            const date = new Date(transact.date);
            let key;
            if (period === "daily") {
              key = date.toISOString().split("T")[0];
            } else if (period === "weekly") {
              const weekStart = new Date(date.setDate(date.getDate() - date.getDay()));
              key = weekStart.toISOString().split("T")[0];
            } else if (period === "monthly") {
              key = date.toLocaleString("default", { month: "long" });
            } else if (period === "yearly") {
              key = date.getFullYear();
            }
            if (!acc[key]) {
              acc[key] = { income: 0, expense: 0, savings: 0 };
            }
            acc[key][transact.type] += transact.amount;
            acc[key].savings = acc[key].income - acc[key].expense;
            return acc;
          }, {});
        };

        let chartInstance;

        const updateChart = (period = "monthly") => {
          const groupedData = groupByPeriod(transactions, period);
          const labels = Object.keys(groupedData);
          const incomeData = labels.map(label => groupedData[label].income);
          const expenseData = labels.map(label => groupedData[label].expense);
          const savingsData = labels.map(label => groupedData[label].savings);

          // Destroy existing chart instance if it exists
          if (chartInstance) {
            chartInstance.destroy();
          }

          // Create new chart instance
          const ctx = document.getElementById("expenseChart").getContext("2d");
          chartInstance = new Chart(ctx, {
            type: "line",
            data: {
              labels: labels,
              datasets: [
                {
                  label: "Income",
                  data: incomeData,
                  backgroundColor: "rgba(0, 128, 0, 0.5)",
                  borderColor: "rgba(0, 128, 0, 1)",
                  borderWidth: 1,
                },
                {
                  label: "Expense",
                  data: expenseData,
                  backgroundColor: "rgba(255, 99, 132, 0.5)",
                  borderColor: "rgba(255, 99, 132, 1)",
                  borderWidth: 1,
                },
                {
                  label: "Savings",
                  data: savingsData,
                  backgroundColor: "rgba(54, 162, 235, 0.5)",
                  borderColor: "rgba(54, 162, 235, 1)",
                  borderWidth: 1,
                },
              ],
            },
            options: {
              responsive: true,
              scales: {
                y: {
                  beginAtZero: true,
                },
              },
            },
          });
        };

        // Initialize chart with default period
        updateChart();

        // Add event listener for period selection
        document.getElementById("btns_inner").addEventListener("change", (event) => {
          updateChart(event.target.value);
        });
      })
      .catch(error => console.error("Error fetching transactions:", error));
  </script>
</html>